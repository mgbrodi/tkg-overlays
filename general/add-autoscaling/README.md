# Add autoscaling to a cluster after the fact

This overlay adds the ability to update a cluster after it has been created to add in autoscaling. This uses the `dry-run` functionality of the tanzu cli along with `kubectl apply` to update the cluster. 


# Usage 

create a directory in `~/.config/tanzu/tkg/providers/ytt/` called `04_run_last` or anything you want to call it but the important part is the start number `04` in this case is the highest number in the directory so that it runs last. if you already have `04` pick a higher number

Copy the `add_autoscaling_values.yml` and the `add_autoscaling.yml` into the `~/.config/tanzu/tkg/providers/ytt/04_run_last` 


This overlay is slightly different than most in that it will remove all of the content that is generated by the tanzu cli other than the components needed for autoscaling. This allows for us to safely run it through `kubectl apply` and not worry about conflicts etc. This is also the reason it need to run last in the order of overlays.


1. Add the autoscaling config to your cluster configuartion file ex.

my-cluster-config.yml:
```yml
ENABLE_AUTOSCALER: true
AUTOSCALER_MIN_SIZE_0: 1
AUTOSCALER_MIN_SIZE_1: 1
AUTOSCALER_MIN_SIZE_2: 2
AUTOSCALER_MAX_SIZE_0: 10
AUTOSCALER_MAX_SIZE_1: 10
AUTOSCALER_MAX_SIZE_2: 10
```

2. Either add the new data value `ADD_AUTOSCALE: true` to the cluster config or use it inline like in the next step.


3. **While in the context of the management cluster** Run the cluster create with the same name as the cluster you want to update and `dry-run` 

```bash 
ADD_AUTOSCALE=true tanzu cluster create my-existing-cluster -f  my-cluster-config.yml --dry-run | kubectl apply -f-
```